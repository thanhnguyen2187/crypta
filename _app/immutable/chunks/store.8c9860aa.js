import{t as Ke,a as Ve}from"./index.5c7cb921.js";import{J as _e,a4 as j,w as Xe,v as Ye,a5 as C,a6 as ue}from"./scheduler.dc60739d.js";import{w as g,r as le,d as k}from"./index.9821de9c.js";let H,fe,J,pe,we,me,ge,ye,ve,be,M,O,he,N,Ee,Ae,De,Se,P,q,$e,xe,Le,Ze=(async()=>{we=function(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)},q=function(e,t){Ke(e,1,1,()=>{t.delete(e.key)})},me=function(e,t){e.f(),q(e,t)},$e=function(e,t,n,r,o,i,a,c,u,f,w,$){let l=e.length,h=i.length,y=l;const E={};for(;y--;)E[e[y].key]=y;const s=[],A=new Map,L=new Map,x=[];for(y=h;y--;){const p=$(o,i,y),v=n(p);let d=a.get(v);d?r&&x.push(()=>d.p(p,t)):(d=f(v,p),d.c()),A.set(v,s[y]=d),v in E&&L.set(v,Math.abs(y-E[v]))}const D=new Set,b=new Set;function S(p){Ve(p,1),p.m(c,w),a.set(p.key,p),w=p.first,h--}for(;l&&h;){const p=s[h-1],v=e[l-1],d=p.key,m=v.key;p===v?(w=p.first,l--,h--):A.has(m)?!a.has(d)||D.has(d)?S(p):b.has(m)?l--:L.get(d)>L.get(m)?(b.add(d),S(p)):(D.add(m),l--):(u(v,a),l--)}for(;l--;){const p=e[l];A.has(p.key)||u(p,a)}for(;h;)S(s[h-1]);return _e(x),s},P=g(void 0),be=function(e,t){const{computePosition:n,autoUpdate:r,offset:o,shift:i,flip:a,arrow:c,size:u,autoPlacement:f,hide:w,inline:$}=j(P),l={open:!1,autoUpdateCleanup:()=>{}},h=':is(a[href], button, input, textarea, select, details, [tabindex]):not([tabindex="-1"])';let y;const E="https://www.skeleton.dev/utilities/popups";let s,A;function L(){s=document.querySelector(`[data-popup="${t.target}"]`)??document.createElement("div"),A=s.querySelector(".arrow")??document.createElement("div")}L();function x(){var m,T,I,re,ae,oe,ie,se;if(!s)throw new Error(`The data-popup="${t.target}" element was not found. ${E}`);if(!n)throw new Error(`Floating UI 'computePosition' not found for data-popup="${t.target}". ${E}`);if(!o)throw new Error(`Floating UI 'offset' not found for data-popup="${t.target}". ${E}`);if(!i)throw new Error(`Floating UI 'shift' not found for data-popup="${t.target}". ${E}`);if(!a)throw new Error(`Floating UI 'flip' not found for data-popup="${t.target}". ${E}`);if(!c)throw new Error(`Floating UI 'arrow' not found for data-popup="${t.target}". ${E}`);const d=[];u&&d.push(u((m=t.middleware)==null?void 0:m.size)),f&&d.push(f((T=t.middleware)==null?void 0:T.autoPlacement)),w&&d.push(w((I=t.middleware)==null?void 0:I.hide)),$&&d.push($((re=t.middleware)==null?void 0:re.inline)),n(e,s,{placement:t.placement??"bottom",middleware:[o(((ae=t.middleware)==null?void 0:ae.offset)??8),i(((oe=t.middleware)==null?void 0:oe.shift)??{padding:8}),a((ie=t.middleware)==null?void 0:ie.flip),c(((se=t.middleware)==null?void 0:se.arrow)??{element:A||null}),...d]}).then(({x:Pe,y:qe,placement:Ge,middlewareData:Qe})=>{if(Object.assign(s.style,{left:`${Pe}px`,top:`${qe}px`}),A){const{x:ce,y:de}=Qe.arrow,We={top:"bottom",right:"left",bottom:"top",left:"right"}[Ge.split("-")[0]];Object.assign(A.style,{left:ce!=null?`${ce}px`:"",top:de!=null?`${de}px`:"",right:"",bottom:"",[We]:"-4px"})}})}function D(){s&&(l.open=!0,t.state&&t.state({state:l.open}),x(),s.style.display="block",s.style.opacity="1",s.style.pointerEvents="auto",s.removeAttribute("inert"),l.autoUpdateCleanup=r(e,s,x),y=Array.from(s==null?void 0:s.querySelectorAll(h)))}function b(d){if(!s)return;const m=parseFloat(window.getComputedStyle(s).transitionDuration.replace("s",""))*1e3;setTimeout(()=>{l.open=!1,t.state&&t.state({state:l.open}),s.style.opacity="0",s.setAttribute("inert",""),l.autoUpdateCleanup&&l.autoUpdateCleanup(),d&&d()},m)}function S(){l.open===!1?D():b()}function p(d){var T;if(l.open===!1||e.contains(d.target))return;if(s&&s.contains(d.target)===!1){b();return}const m=t.closeQuery===void 0?"a[href], button":t.closeQuery;m!==""&&((T=s==null?void 0:s.querySelectorAll(m))==null||T.forEach(I=>{I.contains(d.target)&&b()}))}const v=d=>{if(l.open===!1)return;const m=d.key;if(m==="Escape"){d.preventDefault(),e.focus(),b();return}y=Array.from(s==null?void 0:s.querySelectorAll(h)),l.open&&document.activeElement===e&&(m==="ArrowDown"||m==="Tab")&&h.length>0&&y.length>0&&(d.preventDefault(),y[0].focus())};switch(t.event){case"click":e.addEventListener("click",S,!0),window.addEventListener("click",p,!0);break;case"hover":e.addEventListener("mouseover",D,!0),e.addEventListener("mouseleave",()=>b(),!0);break;case"focus-blur":e.addEventListener("focus",S,!0),e.addEventListener("blur",()=>b(),!0);break;case"focus-click":e.addEventListener("focus",D,!0),window.addEventListener("click",p,!0);break;default:throw new Error(`Event value of '${t.event}' is not supported. ${E}`)}return window.addEventListener("keydown",v,!0),x(),{update(d){b(()=>{t=d,x(),L()})},destroy(){e.removeEventListener("click",S,!0),e.removeEventListener("mouseover",D,!0),e.removeEventListener("mouseleave",()=>b(),!0),e.removeEventListener("focus",S,!0),e.removeEventListener("focus",D,!0),e.removeEventListener("blur",()=>b(),!0),window.removeEventListener("click",p,!0),window.removeEventListener("keydown",v,!0)}}};const G="modalStore";ge=function(){const e=Xe(G);if(!e)throw new Error("modalStore is not initialized. Please ensure that `initializeStores()` is invoked in the root layout file of this app!");return e},ve=function(){const e=ke();return Ye(G,e)};function ke(){const{subscribe:e,set:t,update:n}=g([]);return{subscribe:e,set:t,update:n,trigger:r=>n(o=>(o.push(r),o)),close:()=>n(r=>(r.length>0&&r.shift(),r)),clear:()=>t([])}}const F={};function Q(e){return e==="local"?localStorage:sessionStorage}function R(e,t,n){const r=(n==null?void 0:n.serializer)??JSON,o=(n==null?void 0:n.storage)??"local";function i(a,c){Q(o).setItem(a,r.stringify(c))}if(!F[e]){const a=g(t,f=>{const w=Q(o).getItem(e);w&&f(r.parse(w));{const $=l=>{l.key===e&&f(l.newValue?r.parse(l.newValue):null)};return window.addEventListener("storage",$),()=>window.removeEventListener("storage",$)}}),{subscribe:c,set:u}=a;F[e]={set(f){i(e,f),u(f)},update(f){const w=f(j(a));i(e,w),u(w)},subscribe:c}}return F[e]}R("modeOsPrefers",!1),R("modeUserPrefers",void 0),R("modeCurrent",!1);const W="(prefers-reduced-motion: reduce)";function Ue(){return window.matchMedia(W).matches}Ae=le(Ue(),e=>{{const t=r=>{e(r.matches)},n=window.matchMedia(W);return n.addEventListener("change",t),()=>{n.removeEventListener("change",t)}}});async function Te(e,t){const n=new TextEncoder().encode(t),r=await crypto.subtle.digest("SHA-256",n),o=crypto.getRandomValues(new Uint8Array(12)),i=C.Buffer.from(o).toString("base64"),a={name:"AES-GCM",iv:o},c=await crypto.subtle.importKey("raw",r,a,!1,["encrypt"]),u=new TextEncoder().encode(e),f=await crypto.subtle.encrypt(a,c,u),w=C.Buffer.from(f).toString("base64");return`${i}.${w}`}async function Oe(e,t){const n=new TextEncoder().encode(t),r=await crypto.subtle.digest("SHA-256",n);if(e.indexOf(".")===-1)throw new Error("Invalid ciphertext");const o=e.split("."),i=o[0],a={name:"AES-GCM",iv:C.Buffer.from(i,"base64")},c=await crypto.subtle.importKey("raw",r,a,!1,["decrypt"]),u=o[1],f=C.Buffer.from(u,"base64");try{const w=await crypto.subtle.decrypt(a,c,f);return new TextDecoder().decode(w)}catch{throw new Error("Decrypt failed")}}function Ie(){const e=new Set,t=g(e);return{add:n=>{e.add(n),t.set(e)},remove:n=>{e.delete(n),t.set(e)},subscribe:t.subscribe}}let K,V;M=Ie(),N=g(""),H=g("default"),K={serverURL:"",username:"",password:""},V={default:{id:"default",displayName:"Default",showLockedCard:!0,position:0,createdAt:new Date().getTime(),updatedAt:new Date().getTime()}};function z(e){return`folder.${e}`}async function je(e="default"){const t=await(await navigator.storage.getDirectory()).getDirectoryHandle(z(e),{create:!0}),n=[];for await(let[r,o]of t)if(o.kind==="file"){const i=await(await o.getFile()).text(),a={id:r.replace(".json",""),...JSON.parse(i)};n.push(a)}return n}async function B(e,t="default"){const n=await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle(z(t),{create:!0})).getFileHandle(`${e.id}.json`,{create:!0})).createWritable();await n.write(JSON.stringify(e)),await n.close()}async function _(e,t="default"){await(await(await navigator.storage.getDirectory()).getDirectoryHandle(z(t),{create:!0})).removeEntry(`${e}.json`)}J=function(){return{id:crypto.randomUUID(),name:"Untitled",language:"plaintext",text:"To be filled",tags:[],encrypted:!1,position:0,updatedAt:new Date().getTime(),createdAt:new Date().getTime()}},De=async function(e,t){return{...e,encrypted:!0,text:await Te(e.text,t),updatedAt:new Date().getTime()}},Ee=async function(e,t){return{...e,encrypted:!1,text:await Oe(e.text,t),updatedAt:new Date().getTime()}};async function Ce(){let e=[],t="default";const n=g(e),{subscribe:r,set:o,update:i}=n;return H.subscribe(async a=>{e=await je(a),t=a,o(e)}),{subscribe:r,clone:async a=>{const c={...a,id:crypto.randomUUID(),position:e.length+1,createdAt:new Date().getTime(),updatedAt:new Date().getTime()};await B(c,t),i(u=>(u.push(c),u))},upsert:async a=>{await B(a,t),i(c=>{const u=c.findIndex(f=>f.id===a.id);return u!==-1?c[u]=a:(a.position=c.length+1,c.push(a)),c})},remove:async a=>{await _(a,t),i(c=>{const u=c.findIndex(f=>f.id===a);return u!==-1&&c.splice(u,1),c})},move:async(a,c,u)=>{await _(a.id,c),a.updatedAt=new Date().getTime(),await B(a,u);const f=e.findIndex(w=>w.id===a.id);f!==-1&&e.splice(f,1),o(e)}}}async function Fe(){const e=await(await(await(await navigator.storage.getDirectory()).getFileHandle("settings.json",{create:!0})).getFile()).text(),t=e?JSON.parse(e):{};return Object.assign({},K,t)}Se=async function(){const e=await(await(await(await navigator.storage.getDirectory()).getFileHandle("catalog.json",{create:!0})).getFile()).text(),t=e?JSON.parse(e):{};return Object.assign({},V,t)},Le=async function(e){const t=await(await(await navigator.storage.getDirectory()).getFileHandle("catalog.json",{create:!0})).createWritable();await t.write(JSON.stringify(e)),await t.close()},ye=function(){return{id:crypto.randomUUID(),displayName:"Untitled",showLockedCard:!0,position:0,createdAt:new Date().getTime(),updatedAt:new Date().getTime()}};let X,U,Y,Z;he=g(J()),fe=g("default"),X=(e,t)=>{let n=0;return(...r)=>{let o;return clearTimeout(n),n=setTimeout(()=>{o=e(...r)},t),o}},U=g(await Fe()),Y=Re(5e3),Z=ze();function Re(e=1e3){return le(new Date,t=>{t(new Date);const n=setInterval(()=>{t(new Date)},e);return()=>clearInterval(n)})}function ze(){const e=g("blank"),{set:t,update:n,subscribe:r}=e;async function o(i){if(!i.serverURL)return;const a=ue.Buffer.from(`${i.username}:${i.password}`).toString("base64");if((await fetch(`${i.serverURL}/api/v1/alive`,{headers:{Authorization:`Basic ${a}`}})).status!==200){t("error");return}t("connected")}return U.subscribe(i=>{if(!i.serverURL){t("blank");return}t("connecting")}),U.subscribe(X(o,2e3)),Y.subscribe(()=>{const i=j(U);o(i)}),{subscribe:r}}const ee=He();async function Be(e){const t=`${e.serverURL}/api/v1/snippets`,n=ue.Buffer.from(`${e.username}:${e.password}`).toString("base64"),r=await fetch(t,{headers:{Authorization:`Basic ${n}`}});return r.status!==200?[]:(await r.json()).data}function He(){const e=g([]),{set:t,update:n,subscribe:r}=e;return Z.subscribe(async o=>{if(o!=="connected"){t([]);return}const i=j(U),a=await Be(i);t(a)}),{subscribe:r}}function Je(e,t){return t?e?e.updatedAt!==t.updatedAt?"conflicted":"synchronized":"remoteOnly":"localOnly"}let te;O=await Ce(),xe=k([O,M,N],([e,t,n])=>{n=n.toLowerCase();const r=e.filter(o=>{const i=new Set(o.tags),a=o.name.toLowerCase().includes(n)||o.text.toLowerCase().includes(n),c=Array.from(t.keys()).every(u=>i.has(u));return a&&c});return r.sort((o,i)=>o.position-i.position),r}),te=k([O,ee],([e,t])=>[...e,...t]),k([O,ee],([e,t])=>{const n={};for(const r of e)n[r.id]={localRecord:r,syncState:"localOnly"};for(const r of t)n[r.id]={syncState:"remoteOnly",remoteRecord:r};for(const[r,o]of Object.entries(n))n[r].syncState=Je(o.localRecord,o.remoteRecord);return n});const Me=g({}),ne=k([te,Me],([e,t])=>e.map(n=>({...Ne(n),state:t[n.id]??"default"})).sort((n,r)=>n.position>r.position?1:n.position<r.position?-1:0));k(ne,e=>e.filter(t=>!t.encrypted)),k(ne,e=>e.filter(t=>t.encrypted));function Ne(e){return{id:e.id,title:e.name,language:e.language,content:e.text,encrypted:e.encrypted,state:"default",position:e.position,createdAt:e.createdAt,updatedAt:e.updatedAt}}pe=g(!1)})();export{Ze as __tla,H as a,fe as b,J as c,pe as d,we as e,me as f,ge as g,ye as h,ve as i,be as j,M as k,O as l,he as m,N as n,Ee as o,Ae as p,De as q,Se as r,P as s,q as t,$e as u,xe as v,Le as w};
